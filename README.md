# DemoVideoApp

### Запуск проекта 

```shell
npm start
```
Сервер будет доступен по http://localhost:4200

### Пакеты в репозитории
* __client__
 
Основное клиентское приложение. Дополнительно содержит конфиг для сборки всех приложений

* __server__

Nodejs сервер, который отвечает за 
1. SSR клиентского приложения (`/` - главная, `/watch/:id` - просмотровый)
2. SSR iframe страницы плеера (`/player/:playerVersion/:contendId`)
3. Отдачу статики (`/*.js`)
4. Api для получения данных (`/api/feed`, `/api/related`, `/api/watch/:id`,`/api/player_config/:id`)
5. Api для релизов плеера (`/release/change-player-version/:version`, `/release/get-player-version`, `/release/get-player-resources`)

* __player__

Код библиотеки с плеером. На содержимое этого пакета напрямую не влияем нашими улучшениями.
Собранный код библиотеки версионируется (для эмуляции этого сделано просто несколько точек входа).

### Фичи

Улучшения разбиты коммитами на этапы
https://github.com/spashav/Demo-video-app/commits/main

Фичи их каждого этапа включаются через флаги, которые можно передать в query параметрах. Например

http://localhost:4200/watch/24?useFake=1&disableIframe=1&usePreloadAndDelayedRelated=1&useDelayedApp=1&useChunkedRendering=1

Список флагов
- useFake. 
  - Включает отрисовку фейков при загрузке данных.
- disableIframe
  - Убирает iframe при вставке плеера.
- usePreloadAndDelayedRelated
  - Предзагружает ресурсы плеера (скрипты и стили).
  - Добавлет получение конфига плеера в api рекомендаций и ленты.
  - Откладывает загрузку связанных видео в экране просмотра до момента старта воспроизведения.
- useDelayedApp
  - Добавляет получение плеерных ресурсов на сервере.
  - Добавляет вставку плеерных ресурсов в html страницы (т.е. переносим инициализацию загрузки ресурсов из js в html).
  - Добавляет отображение первого кадра в качестве превью плеера.
  - Получаем конфиг плеера на сервере и инлайним на страницу (т.е. убираем этот запрос с клиента).
  - На сервере сразу после контейнера с плеером вставляем инлайн скрипт с инициализацией плеера.
  - Откладывает загрузку основного js бадла до начала воспроизведения видео.
- useChunkedRendering
  - Делает загрузку ресурсов плеера неблокирующей отрисовку html.
  - Добавляет чанковую отрисовку на странице просмотра. 
    - Сначала на клиент отправляется часть html до связанных видео (в первый чанк попадает шапка, плеер и инлайн скрипт с его инициализацией)
    - Дальше на сервере идет запрос за связанными видео
    - После получения данных идёт отрисовка html со связанными видео и отправка на клиент второго чанка разметки
